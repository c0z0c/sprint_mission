
// ì˜¨ë¼ì¸ ë·°ì–´ë¡œ íŒŒì¼ ë³´ê¸° í•¨ìˆ˜
function openGoogleSheetsViewer(fileName) {
const githubRawUrl = `${raw_url}${fileName}`;
// Google Sheets Import ê¸°ëŠ¥ ì‚¬ìš©
const googleSheetsUrl =
`https://docs.google.com/spreadsheets/d/e/2PACX-1vT7fUCH9Z_pX8K2vJ7Z3uE4fUCH9Z_pX8K2vJ7Z3uE4/pubhtml?embedded=true&url=${encodeURIComponent(githubRawUrl)}`;
window.open(googleSheetsUrl, '_blank');
}

// CSV ë·°ì–´ í•¨ìˆ˜
function openCSVViewer(fileName) {
  const modal = createViewerModal(`CSV ë·°ì–´ - ${fileName}`);
  const content = modal.querySelector('.viewer-content');

  fetch(`${raw_url}${fileName}`)
  .then(response => response.text())
  .then(data => {
    const rows = data.split('\n').map(row => row.split(','));
    let html = '<table border="1" style="border-collapse: collapse; width: 100%;">';
      rows.forEach((row, index) => {
      html += '<tr>';
        row.forEach(cell => {
        const tag = index === 0 ? 'th' : 'td';
        html += `<${tag} style="padding: 8px; border: 1px solid #ddd;">${cell.trim()}</${tag}>`;
        });
        html += '</tr>';
      });
      html += '</table>';
    content.innerHTML = html;
  })
  .catch(error => {
    content.innerHTML = `<p>CSV íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>`;
  });
}

// JSON ë·°ì–´ í•¨ìˆ˜
function openJSONViewer(fileName) {
const modal = createViewerModal(`JSON ë·°ì–´ - ${fileName}`);
const content = modal.querySelector('.viewer-content');

fetch(`${raw_url}${fileName}`)
.then(response => response.json())
.then(data => {
content.innerHTML = `
<pre
  style="background: #f5f5f5; padding: 20px; border-radius: 5px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>
`;
})
.catch(error => {
  content.innerHTML = `<p>JSON íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>`;
});
}

// ëª¨ë‹¬ ìƒì„± í•¨ìˆ˜
function createViewerModal(title) {
  const modal = document.createElement('div');
  modal.style.cssText = `
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
  align-items: center; justify-content: center;
  `;

  modal.classList.add('viewer-modal');
  modal.innerHTML = `
  <div style="background: white; width: 90%; height: 90%; border-radius: 10px; overflow: hidden;">
    <div
      style="background: #f0f0f0; padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">${title}</h3>
      <button onclick="this.closest('.viewer-modal').remove()"
        style="background: #ff5f56; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">Ã—</button>
    </div>
    <div class="viewer-content" style="padding: 20px; height: calc(100% - 70px); overflow: auto;">
      <p>ë¡œë”© ì¤‘...</p>
    </div>
  </div>
  `;

  document.body.appendChild(modal);
  return modal;
}

// íŒŒì¼ ì•¡ì…˜ ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
function getFileActions(file) {
  const fileName = file.name;
  const fileExt = file.extname.toLowerCase();
  const githubRawUrl = `${raw_url}${fileName}`;

  let actions = '';

  // Markdown íŒŒì¼ ì²˜ë¦¬
  if (fileExt === '.md' && fileName !== 'index.md') {
    const mdName = fileName.replace('.md', '');
    actions += `<a href="${site_url}${mdName}" class="file-action" title="ë Œë”ë§ëœ í˜ì´ì§€ ë³´ê¸°">ğŸŒ</a>`;
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ì›ë³¸ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }

  // Jupyter Notebook ì²˜ë¦¬
  else if (fileExt === '.ipynb') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
    actions += `<a href="${colab_url}${fileName}" class="file-action" title="Colabì—ì„œ ì—´ê¸°" target="_blank">ğŸš€</a>`;
    // NBViewer ì¶”ê°€
    actions += `<a href="https://nbviewer.org/github/${git_url.split('github.com/')[1].replace('/blob/', '/')}${fileName}" class="file-action" title="NBViewerë¡œ ë³´ê¸°" target="_blank">ğŸ“Š</a>`;
  }

  // PDF íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.pdf') {
    actions += `<a href="${site_url}${fileName}" class="file-action" title="ë Œë”ë§ëœ í˜ì´ì§€ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“„</a>`;
  }

  // Microsoft Office ë¬¸ì„œ (Word, PowerPoint)
  else if (fileExt === '.docx' || fileExt === '.pptx') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }

  // Excel íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.xlsx' || fileExt === '.xls') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }

  // CSV íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.csv') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
    // CSV ë·°ì–´ (ë³„ë„ êµ¬í˜„)
    actions += `<a href="javascript:openCSVViewer('${fileName}')" class="file-action" title="CSV ë°ì´í„° ë³´ê¸°">ğŸ“Š</a>`;
  }

  // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
  else if (['.png', '.jpg', '.jpeg', '.gif', '.svg'].includes(fileExt)) {
    actions += `<a href="${githubRawUrl}" class="file-action" title="ì´ë¯¸ì§€ ë³´ê¸°" target="_blank">ğŸ–¼ï¸</a>`;
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }

  // HWP íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.hwp') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë‹¤ìš´ë¡œë“œ" target="_blank">ğŸ“¥</a>`;
    actions += `<a href="javascript:alert('HWP íŒŒì¼ì€ ì˜¨ë¼ì¸ ë·°ì–´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì¸í•´ì£¼ì„¸ìš”.')" class="file-action"
      title="ë·°ì–´ ì§€ì› ì•ˆí•¨">âŒ</a>`;
  }

  // HTML íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.html') {
    actions += `<a href="${site_url}${fileName}" class="file-action" title="ì›¹í˜ì´ì§€ë¡œ ë³´ê¸°" target="_blank">ğŸŒ</a>`;
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ì›ë³¸ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }

  // JSON íŒŒì¼ ì²˜ë¦¬
  else if (fileExt === '.json') {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
    actions += `<a href="javascript:openJSONViewer('${fileName}')" class="file-action" title="JSON ë·°ì–´ë¡œ ë³´ê¸°">âš™ï¸</a>`;
  }

  // ê¸°íƒ€ í…ìŠ¤íŠ¸ íŒŒì¼ (.py, .txt, .js, .css ë“±)
  else if (['.py', '.js', '.css', '.txt', '.xml', '.yaml', '.yml'].includes(fileExt)) {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
    actions += `<a href="${githubRawUrl}" class="file-action" title="ì›ë³¸ í…ìŠ¤íŠ¸ ë³´ê¸°" target="_blank">ğŸ“„</a>`;
  }

  // ì••ì¶• íŒŒì¼
  else if (['.zip', '.rar', '.7z', '.tar', '.gz'].includes(fileExt)) {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ë‹¤ìš´ë¡œë“œ" target="_blank">ğŸ“¥</a>`;
  }

  // ê¸°íƒ€ íŒŒì¼
  else {
    actions += `<a href="${git_url}${fileName}" class="file-action" title="GitHubì—ì„œ ì›ë³¸ ë³´ê¸°" target="_blank">ğŸ“–</a>`;
  }
  return actions;
}

// DOMì´ ë¡œë“œëœ í›„ íŒŒì¼ ëª©ë¡ ë Œë”ë§
document.addEventListener('DOMContentLoaded', function() {
  const fileGrid = document.querySelector('.file-grid');

  if (curFiles.length === 0) {
    fileGrid.innerHTML = `
    <div class="empty-message">
      <span class="empty-icon">ğŸ“„</span>
      <h3>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>í˜„ì¬ ì´ ìœ„ì¹˜ì—ëŠ” ì™„ë£Œëœ ë¯¸ì…˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    `;
    return;
  }

  let html = `
  <table class="file-table">
  <thead>
    <tr>
      <th onclick="sortTable(0)" style="cursor: pointer; width:110px;">ë‚ ì§œ â¬</th>
      <th onclick="sortTable(1)" style="cursor: pointer;">ì œëª© â¬</th>
      <th onclick="sortTable(2)" style="cursor: pointer;">íŒŒì¼ëª… â¬</th>
      <th onclick="sortTable(3)" style="cursor: pointer;">íƒ€ì… â¬</th>
      <th onclick="sortTable(4)" style="cursor: pointer;">View â¬</th>
      <th onclick="sortTable(5)" style="cursor: pointer;">Gitâ¬</th>
    </tr>
  </thead>
  <tbody>
    `;

    curFiles.forEach(file => {
      if (file.name === 'index.md' || file.name === 'info.md') return;

      const fileInfo = getFileInfo(file.extname);
      const fileDate = file.modified_time ? new Date(file.modified_time).toLocaleDateString('ko-KR') : '';
      const fileName = file.name;
      const fileExt = file.extname.toLowerCase();

      // ë Œë”ë§í˜ì´ì§€ ë§í¬ ìƒì„±
      let renderLink = '';
      if (fileExt === '.md' && fileName !== 'index.md') {
        const mdName = fileName.replace('.md', '');
        renderLink = `<a href="${site_url}${mdName}" title="ë Œë”ë§ëœ í˜ì´ì§€ ë³´ê¸°" target="_blank">ğŸŒ</a>`;
      } else if (fileExt === '.ipynb') {
        renderLink = `<a href="${colab_url}${fileName}" title="Colabì—ì„œ ì—´ê¸°" target="_blank">ğŸš€</a>`;
      } else if (fileExt === '.pdf') {
        renderLink = `<a href="https://docs.google.com/viewer?url=${raw_url}${fileName}" title="PDF ë·°ì–´ë¡œ ì—´ê¸°"
        target="_blank">ğŸ“„</a>`;
      } else if (fileExt === '.docx') {
        renderLink = `<a href="https://docs.google.com/viewer?url=${raw_url}${fileName}" title="Googleì—ì„œ ì—´ê¸°"
        target="_blank">ğŸ“Š</a>`;
      } else if (fileExt === '.html') {
        renderLink = `<a href="${site_url}${fileName}" title="ì›¹í˜ì´ì§€ë¡œ ë³´ê¸°" target="_blank">ğŸŒ</a>`;
      } else if (fileExt === '.csv') {
        renderLink = `<a href="javascript:openCSVViewer('${fileName}')" title="CSV ë°ì´í„° ë³´ê¸°">ğŸ“Š</a>`;
      } else if (fileExt === '.json') {
        renderLink = `<a href="javascript:openJSONViewer('${fileName}')" title="JSON ë·°ì–´ë¡œ ë³´ê¸°">âš™ï¸</a>`;
      } else if (['.png', '.jpg', '.jpeg', '.gif', '.svg'].includes(fileExt)) {
        renderLink = `<a href="${raw_url}${fileName}" title="ì´ë¯¸ì§€ ë³´ê¸°" target="_blank">ğŸ–¼ï¸</a>`;
      } else if (['.py', '.js', '.css', '.txt', '.xml', '.yaml', '.yml'].includes(fileExt)) {
        renderLink = `<a href="${site_url}${fileName}" title="ë Œë”ë§ëœ í˜ì´ì§€ ë³´ê¸°" target="_blank">ğŸŒ</a>`;
      } else {
        renderLink = '-';
      }

      // Git ì§ì ‘ ë§í¬
      const gitLink = `<a href="${git_url}${fileName}" title="GitHubì—ì„œ ì›ë³¸ ë³´ê¸°" target="_blank">ğŸ“–</a>`;

      // ì œëª© í´ë¦­ ì‹œ ë Œë”ë§ í˜ì´ì§€ ë§í¬ ìƒì„±
      let titleClickable = `<span class="file-icon">${fileInfo.icon}</span> ${file.title || file.name}`;
      if (fileExt === '.md' && fileName !== 'index.md') {
        const mdName = fileName.replace('.md', '');
        titleClickable = `<span class="file-icon">${fileInfo.icon}</span> <a href="${site_url}${mdName}" title="ë Œë”ë§ëœ í˜ì´ì§€ ë³´ê¸°"
        target="_blank" style="text-decoration: none; color: inherit;">${file.title || file.name}</a>`;
      } else if (fileExt === '.ipynb') {
        titleClickable = `<span class="file-icon">${fileInfo.icon}</span> <a href="${colab_url}${fileName}"
        title="Colabì—ì„œ ì—´ê¸°" target="_blank" style="text-decoration: none; color: inherit;">${file.title || file.name}</a>`;
      } else if (fileExt === '.pdf') {
        titleClickable = `<span class="file-icon">${fileInfo.icon}</span> <a
        href="https://docs.google.com/viewer?url=${raw_url}${fileName}" title="PDF ë·°ì–´ë¡œ ì—´ê¸°" target="_blank"
        style="text-decoration: none; color: inherit;">${file.title || file.name}</a>`;
      } else if (fileExt === '.docx') {
        titleClickable = `<span class="file-icon">${fileInfo.icon}</span> <a
        href="https://docs.google.com/viewer?url=${raw_url}${fileName}" title="Googleì—ì„œ ì—´ê¸°" target="_blank"
        style="text-decoration: none; color: inherit;">${file.title || file.name}</a>`;
      } else if (fileExt === '.html') {
        titleClickable = `<span class="file-icon">${fileInfo.icon}</span> <a href="${site_url}${fileName}" title="ì›¹í˜ì´ì§€ë¡œ ë³´ê¸°"
        target="_blank" style="text-decoration: none; color: inherit;">${file.title || file.name}</a>`;
      }

      // íŒŒì¼ëª… í´ë¦­ ì‹œ Git ì§ì ‘ ì—°ê²°
      const fileNameClickable = `<a href="${git_url}${fileName}" title="GitHubì—ì„œ ì›ë³¸ ë³´ê¸°" target="_blank"
      style="text-decoration: none; color: inherit;">${fileName}</a>`;

      html += `
      <tr>
        <td>${fileDate}</td>
        <td>${titleClickable}</td>
        <td>${fileNameClickable}</td>
        <td>${fileInfo.type}</td>
        <td>${renderLink}</td>
        <td>${gitLink}</td>
      </tr>
      `;
    });

    html += `
    </tbody>
  </table>
  `;

  fileGrid.innerHTML = html;
});

// í…Œì´ë¸” ì •ë ¬ ê¸°ëŠ¥
let sortDirection = {}; // ê° ì»¬ëŸ¼ì˜ ì •ë ¬ ë°©í–¥ì„ ì €ì¥

function sortTable(columnIndex, sort_type='Toggle') {
  const table = document.querySelector('.file-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));

  // sort_typeì— ë”°ë¼ ì •ë ¬ ë°©í–¥ ê²°ì •
  let isAscending;
  if (sort_type === 'Asc') {
    isAscending = true;
    sortDirection[columnIndex] = 'asc';
  } else if (sort_type === 'Desc') {
    isAscending = false;
    sortDirection[columnIndex] = 'desc';
  } else {
    // Toggle ëª¨ë“œ
    isAscending = sortDirection[columnIndex] !== 'asc';
    sortDirection[columnIndex] = isAscending ? 'asc' : 'desc';
  }

  // í—¤ë” í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
  const headers = table.querySelectorAll('th');
  headers.forEach((header, index) => {
    if (index === columnIndex) {
      const arrow = isAscending ? ' â¬†' : ' â¬‡';
      header.innerHTML = header.innerHTML.replace(/ [â¬†â¬‡â¬]/g, '') + arrow;
    } else {
      header.innerHTML = header.innerHTML.replace(/ [â¬†â¬‡â¬]/g, '') + ' â¬';
    }
  });

// í–‰ ì •ë ¬
  rows.sort((a, b) => {
    let aValue = a.cells[columnIndex].textContent || a.cells[columnIndex].innerText;
    let bValue = b.cells[columnIndex].textContent || b.cells[columnIndex].innerText;

    // ë‚ ì§œ ì»¬ëŸ¼ì¸ ê²½ìš° ë‚ ì§œë¡œ íŒŒì‹±
    if (columnIndex === 0) {
      aValue = aValue ? new Date(aValue).getTime() : 0;
      bValue = bValue ? new Date(bValue).getTime() : 0;
    }
      // ìˆ«ìê°€ í¬í•¨ëœ ë¬¸ìì—´ì˜ ê²½ìš° ìì—° ì •ë ¬
    else {
      // ì•„ì´ì½˜ ì œê±° (ì œëª© ì»¬ëŸ¼ì˜ ê²½ìš°)
      aValue = aValue.replace(/[ğŸ““ğŸğŸ“âš™ï¸ğŸ“¦ğŸ–¼ï¸ğŸ“ŠğŸ“„]/g, '').trim();
      bValue = bValue.replace(/[ğŸ““ğŸğŸ“âš™ï¸ğŸ“¦ğŸ–¼ï¸ğŸ“ŠğŸ“„]/g, '').trim();
    }

    let comparison = 0;
    if (typeof aValue === 'number' && typeof bValue === 'number') {
      comparison = aValue - bValue;
    } else {
      comparison = aValue.toString().localeCompare(bValue.toString(), 'ko-KR', {
        numeric: true,
        caseFirst: 'lower'
      });
    }
    return isAscending ? comparison : -comparison;
  });

  // ì •ë ¬ëœ í–‰ë“¤ì„ ë‹¤ì‹œ tbodyì— ì¶”ê°€
  rows.forEach(row => tbody.appendChild(row));
}