
{% assign all_files = site.static_files %}
{%- assign all_pages = site.pages -%}

{%- assign cur_file_dir = cur_dir -%}
{%- assign cur_page_dir = page.dir -%}

{% if cur_file_dir == nil or cur_file_dir == "" %}
  {%- assign cur_dirs = "" -%}
  {%- assign cur_files = "" -%}

{% else %}

  {%- if cur_file_dir == "/" -%}
    {%- assign cur_deep_size = 1 -%}
  {%- else -%}
    {%- assign cur_deep = cur_file_dir | split: "/" | reject: "" -%}
    {%- assign cur_deep_size = cur_deep | size -%}
  {%- endif -%}

// console.log('cur_file_dir:', '{{- cur_file_dir -}}');
// console.log('cur_page_dir:', '{{- cur_page_dir -}}');
// console.log('cur_deep_size:', '{{- cur_deep_size -}}');

  <!-- fiels -->
// console.log('files');
  {% for f in all_files %}
    {%- assign f_deep = f.path | split: "/" | reject: "" -%}
    {%- assign f_deep_size = f_deep | size | minus: 1 -%}
// console.log('f.path:', ' ({{- cur_deep_size -}},{{- f_deep_size -}}) {{- f.path -}}'); 
  {% endfor %}
// console.logEnd();

// console.log('cur files'); 
  {%- assign cur_files = "" | split: "" -%}
  {%- for f in all_files -%}
    {%- assign f_deep = f.path | split: "/" | reject: "" -%}
    {%- assign f_deep_size = f_deep | size | minus: 1 -%}

    {%- assign cur_file_dir_len = cur_file_dir | size -%}
    {%- assign f_path_start = f.path | slice: 0, cur_file_dir_len -%}

    {%- assign f_s_path = f.path | slice: 0, 1 -%}
    {%- assign f_e_path = f.path | slice: -1, 1 -%}

    {%- if f_path_start == cur_file_dir -%}
      {%- if cur_deep_size == f_deep_size -%}
        {%- assign f_s_path = f.path | slice: 0, 1 -%}
        {%- assign f_e_path = f.path | slice: -1, 1 -%}
        {%- assign cur_files = cur_files | push: f -%}
// console.log('+ f.path:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- f.path -}}'); 
      {%- endif -%}
    {%- endif -%}
  {% endfor %}
// console.logEnd();

  <!-- pages -->
// console.log('pages');
  {%- for f in all_pages -%}
    {%- assign f_path = "/" | append: f.path -%}
    {%- assign f_deep = f_path | split: "/" | reject: "" -%}
    {%- assign f_deep_size = f_deep | size | minus: 1 -%}
// console.log('f.path:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- f_path -}}'); 
  {% endfor %}
// console.logEnd();

// console.log('cur pages');
  {%- assign cur_pages = "" | split: "" -%}
  {%- for f in all_pages -%}
    {%- assign f_path = "/" | append: f.path -%}
    
    {%- assign f_deep = f_path | split: "/" | reject: "" -%}
    {%- assign f_deep_sub_size = f_deep | size -%}
    {%- assign f_deep_size = f_deep | size | minus: 1 -%}

    {%- assign cur_page_dir_len = cur_dir | size -%}
    {%- assign f_path_start = f_path | slice: 0, cur_page_dir_len -%}
    {%- assign f_s_path = f_path | slice: 0, 1 -%}
    {%- assign f_e_path = f_path | slice: -1, 1 -%}

{%- if f_path_start == cur_dir -%}
      {%- if cur_deep_size == f_deep_size -%}
        {%- assign f_s_path = f_path | slice: 0, 1 -%}
        {%- assign f_e_path = f_path | slice: -1, 1 -%}
        {% assign cur_pages = cur_pages | push: f %}
// console.log('+ 0 f.path:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- f_path -}}'); 

      {%- elsif cur_deep_size == f_deep_sub_size and f.name == 'index.md' -%}
        {% assign cur_pages = cur_pages | push: f %}
// console.log('+ 1  f.path:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- f_path -}}'); 

      {% else %}
// console.log('* f.path:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- f_path -}}'); 

      {%- endif -%}
    {%- endif -%}
  {% endfor %}
// console.logEnd();

  {%- capture cur_files_json -%}
  [
  {%- for f in cur_files -%}
    {
      "name": {{- f.name | jsonify -}},
      "path": {{- f.path | jsonify -}},
      "extname": {{- f.extname | jsonify -}},
      "modified_time": {{- f.modified_time | jsonify -}},
      "basename": {{- f.basename | default: "" | jsonify -}},
      "url": {{- f.url | default: "" | jsonify -}}
    }{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
  ]
  {%- endcapture -%}

  {%- capture cur_pages_json -%}
  [
  {%- for p in cur_pages -%}
  {%- assign p_path = "/" | append: p.path -%}
    {
      "title": {{- p.title | jsonify -}},
      "url": {{- p.url | jsonify -}},
      "path": {{- p_path | jsonify -}},
      "dir": {{- p.dir | jsonify -}},
      "name": {{- p.name | default: "" | jsonify -}},
      "layout": {{- p.layout | default: "" | jsonify -}},
      "date": {{- p.date | default: "" | jsonify -}},
      "excerpt": {{- p.excerpt | default: "" | jsonify -}},
      "categories": {{- p.categories | default: "" | jsonify -}},
      "tags": {{- p.tags | default: "" | jsonify -}}
    }{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
  ]
  {%- endcapture -%}
{% endif %}


<!-- 서브 폴더 가져오기 files -->
// console.log('sub files'); 
  {%- assign sub_folder = "" | split: "" -%}
  {%- for f in all_files -%}
    {%- assign f_deep = f.path | split: "/" | reject: "" -%}
    {%- assign f_deep_size = f_deep | size | minus: 2 -%}

    {%- assign cur_file_dir_len = cur_file_dir | size -%}
    {%- assign f_path_start = f.path | slice: 0, cur_file_dir_len -%}
    {%- assign f_path_last = f.path | remove_first: cur_file_dir -%}
    {%- if f_path_start == cur_file_dir -%}
      {%- if cur_deep_size == f_deep_size -%}
        {%- assign path_parts = f_path_last | split: '/' -%}
        {%- if path_parts.size > 1 -%}
          {%- assign folder = path_parts[0] -%}
          {%- unless sub_folder contains folder or folder == '' or folder contains '.' or folder == 'assets' or folder == '_layouts' -%}
            {% assign sub_folder = sub_folder | push: folder %}
// console.log('+file folder:', ' ({{- cur_deep_size -}},{{- f_deep_size -}}) {{- folder -}}'); 
          {%- endunless -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {% endfor %}
// console.logEnd();

<!-- 서브 폴더 가져오기 pages -->
// console.log('sub pages');
  {%- for f in all_pages -%}
    {%- assign f_path = "/" | append: f.path -%}
    
    {%- assign f_deep = f_path | split: "/" | reject: "" -%}
    {%- assign f_deep_size = f_deep | size | minus: 2 -%}

    {%- assign cur_file_dir_len = cur_file_dir | size -%}
    {%- assign f_path_start = f_path | slice: 0, cur_file_dir_len -%}
    {%- assign f_path_last = f_path | remove_first: cur_file_dir -%}
    {%- if f_path_start == cur_file_dir -%}
      {%- if cur_deep_size == f_deep_size -%}
        {%- assign path_parts = f_path_last | split: '/' -%}
        {%- if path_parts.size > 1 -%}
          {%- assign folder = path_parts[0] -%}
          {%- unless sub_folder contains folder or folder == '' or folder contains '.' or folder == 'assets' or folder == '_layouts' -%}
            {% assign sub_folder = sub_folder | push: folder %}
// console.log('+page folder:', ' ({{ cur_deep_size }},{{ f_deep_size }}) {{- folder -}}'); 
          {%- endunless -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {% endfor %}
// console.logEnd();

{% capture sub_folder_json %}
[
{%- for folder in sub_folder -%}
  {{- folder | jsonify -}}{%- unless forloop.last -%},{%- endunless -%}
{% endfor %}
]
{% endcapture %}

